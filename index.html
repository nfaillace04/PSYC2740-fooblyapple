<!DOCTYPE html>
<html>
  <head>
    <title> Foobly Apple's First Experiment</title>
    <script src="https://unpkg.com/jspsych@7.3.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
    <link href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css" rel="stylesheet" type="text/css" />
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3"></script>
    <script src="jspsych/modified-image-plugin.js"></script>
    <script src = "dodish-pos (updated).js"></script>
    <script src = "foobly-pos(updated).js"></script>
    <script src = "nuppical-pos (updated).js"></script>
    <script src = "meaningcheck.js"></script>
    <script src = "priming.js"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.4"></script>

  </head>
  <body>
  </body>
  <script>
    const jsPsych = initJsPsych();
    
    var id = Math.floor(Math.random()* 1000000000);
        console.log("id=", id)
        jsPsych.data.addProperties({
            ID: id
         });

    var random_attention_trials = jsPsych.randomization.sampleWithoutReplacement([...Array(35).keys()].map(x => x + 5), 3);

    console.log("random_attention_trials= " + random_attention_trials);

    var CONDITION = jsPsych.randomization.sampleWithoutReplacement([...Array(3).keys()], 1)[0];

    console.log("CONDITION" + CONDITION);

    var experiment_stimuli = get_stimuli(CONDITION)

    var sentence_number = 0
     
    var sentence = {
        type:jsPsychHtmlKeyboardResponse,
        stimulus: jsPsych.timelineVariable('sentence'),
        choices: [' '],
        on_finish: function(data) {
            sentence_number = (sentence_number + 1) % 40;
            //console.log("sentence_number= " + sentence_number);
        },
        data: {
            typeoftrial: 'sentence',
            novel: jsPsych.timelineVariable('novel'),
            valence: jsPsych.timelineVariable('valence')
        }
    };

    var slow_experiment_trial = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "<br>Too slow! <br><br> Please try to respond faster.",
        choices:"NO_KEYS",
        trial_duration: 1000
    };

    var attention = {
        type: jsPsychSurveyText,
        questions: [{prompt: "Type any ONE novel word from the previous sentence:"}],
        data: {
            typeoftrial: 'attention',
        },
        on_finish: function(data){
            var last_trial_data = jsPsych.data.get().filter({typeoftrial: 'sentence'}).last(1).values()[0];
            console.log('last_trial_data=',last_trial_data),

            data.novel = last_trial_data.novel,
            data.response = data.response.Q0;
            
            console.log('response', data.response)
        if(
            jsPsych.pluginAPI.compareKeys(data.response, data.novel)
           ){
            data.correct = 1,
            console.log('correct=' + data.correct)
           } else {
            data.correct = 0,
            console.log('correct=' + data.correct)
           }
         }
    };

    var attention_conditional = {
        timeline: [attention],
        conditional_function: function() {
            if(random_attention_trials.includes(sentence_number)) {return true;}
            else {return false;}
    }
    };

    var meaning_check = {
        type: jsPsychSurveyText,
        questions: [
            {prompt: jsPsych.timelineVariable('cue')}
        ],
        data: {
            typeoftrial: 'meaning_check'
        },
        repetitions: 3
    };

    var fixation = {
        type:jsPsychHtmlKeyboardResponse,
        stimulus: '+',
        choices: ['NO_KEYS'],
        trial_duration: 500,
        data: {
            typeoftrial: 'fixation'
        }
    };

    var image = {
        type: jsPsychImageKeyboardResponse,
        stimulus: jsPsych.timelineVariable('image_path'),
        choices: ['NO_KEYS'],
        trial_duration: 500,
        stimulus_width: 500,
        maintain_aspect_ratio: true,
        prompt: "<span style = 'font-size:200%'><br><br></span>",
        data: {
            typeoftrial: 'image'
        }
    };

    var prime = {
        type: jsPsychImageKeyboardResponse,
        stimulus: jsPsych.timelineVariable('image_path'),
        choices: ['NO_KEYS'],
        trial_duration: 500,
        stimulus_width: 500,
        maintain_aspect_ratio: true,
        prompt: function(){
            return "<span style= 'font-size:200%'><br>" + String(jsPsych.timelineVariable('prime_word')) + "<br></span";

        },
        data: {
            typeoftrial: 'prime'
        }
    };

    var target = {
        type: jsPsychImageKeyboardResponse,
        stimulus: jsPsych.timelineVariable('image_path'),
        choices: ['A','L'],
        stimulus_width: 500,
        maintain_aspect_ratio: true,
        prompt: function(){
            return "<span style= 'font-size:200%'><br>" + String(jsPsych.timelineVariable('target_word')) + "<br></span";
        },
        data: {
            typeoftrial: 'target'
        }
    };

    var priming_feedback = {
      timeline: [slow_experiment_trial],
      conditional_function: function (){
        var rt = jsPsych.data.get().last(1).values()[0].rt;
        if (rt > 800){
            return true;
        } else {
            return false;
        }
      },
      data: {
            typeoftrial: 'feedback'
        }
    };

    var training_procedure = {
        timeline: [sentence, attention_conditional],
        timeline_variables: experiment_stimuli, 
        randomize_order: true
    };

    var meaningcheck_instructions = {
        type: jsPsychInstructions,
        pages: [
            'Done with sentences. Please follow the next set of instructions.',
         ],
         show_clickable_nav: true
    };

    var meaningcheck_procedure = {
        timeline: [meaningcheck_instructions, meaning_check],
        timeline_variables: meaning_check1, meaning_check2, meaning_check3,
        repetitions: 1,
        randomization: true
    }

    var training_plus_meaningcheck = {
        timeline: [training_procedure, meaningcheck_procedure],
        repetitions: 1
    };

    var priming_procedure = {
        timeline: [fixation, image, prime, target, priming_feedback],
        timeline_variables: test_stimuli,
        randomize_order: true
    };
    
    var initial_instructions = {
        type: jsPsychInstructions,
        pages: [
            'How do we learn new words? <br><br>Most of the words we know we learned spontaneously, like when hearing a novel word while listening to someone speaking, watching TV or while reading.<br><br> In this study, your task will be to simply read sentences containing new words. After the reading session, we will ask you to create new sentences with the novel words and then to use them in a word game. <br><br>This experiment has three blocks. Each block has reading and testing session.<br><br> Are you ready to start?',
            'On the screen, you will be presented with one sentence at a time. <br><br>Read them carefully. When you are ready, press SPACE BAR for the next sentence. <br><br>To ensure you are reading carefully, there will be surprise questions during the reading session. <br><br>You will be prompted to type the novel words from the last sentence you read. <br><br>Minor spelling mistakes will be tolerated. Type in your answer and press enter when you are ready to move on to the next sentence.',
            'You will now read the sentences. <br> Press SPACE BAR when you have read the sentence and want to move on to the next.'
         ],
         show_clickable_nav: true
    };

    var priming_instructions = {
        type: jsPsychInstructions,
        pages: [
            'Priming task is about to begin.'
         ],
         show_clickable_nav: true
    };
    var thank_you = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "Thank you! You can press any key to end the experiment.",
        data: {
            typeoftrial: 'thank_you'
        },
    }
    function get_stimuli(CONDITION) {
        if (CONDITION == 0) {
            return test_stimuli_1;
        } else if (CONDITION == 1) {
            return test_stimuli_2;
        } else {
            return test_stimuli_3;
    }
}

jsPsych.run([initial_instructions, training_plus_meaningcheck, priming_instructions, priming_procedure]);
//jsPsych.run([priming_procedure]);
  </script>
</html>
